################################################################################
#                  _             
#  ___ _ __   __ _| | _____  ___ 
# / __| '_ \ / _` | |/ / _ \/ __|
# \__ \ | | | (_| |   <  __/\__ \
# |___/_| |_|\__,_|_|\_\___||___/
#                               
# Data integration and machine learning pipeline built on Snakemake
#
# https://github.com/khughitt/snakes
#
################################################################################
import glob
import os
import yaml
import pandas as pd

#
#  {{ config['name'] }} {{ config['version'] }}
#

# load sample and response metadata
sample_metadata   = yaml.load(open('{{ config['metadata']['samples'] }}'))
response_metadata = yaml.load(open('{{ config['metadata']['response'] }}'))

{# dictionary used to keep track of the most recent rules for each data type -#}
{% set most_recent_rules = {} -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Load features                                                                             -#}
{#                                                                                           -#}
{############################################################################################-#}
{% for key, dataset in datasets.items() -%}
    {% include 'data/' + dataset['name'] + '.snakefile' -%}
{% endfor -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Aggregation (clustering)
{#                                                                                           -#}
{############################################################################################-#}
{% for clust_method, clust_params in config['clustering'].items() -%}
{% for dataset_name, dataset_params in datasets.items() -%}
{% if dataset_params['role'] == 'feature' -%}
    {% set cur_input = most_recent_rules[dataset_name] -%}
    {% include 'aggregation/' + clust_method + '.snakefile' %}
{% endif -%}
{% endfor -%}
{% endfor -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Aggregation (gene sets)
{#                                                                                           -#}
{############################################################################################-#}
{% for gene_set, gene_set_params in config['gene_sets'].items() -%}
{% for dataset_name, dataset_params in datasets.items() -%}
{% if dataset_params['role'] == 'feature' -%}
    {% set cur_input = config['output_dir'] + '/' + dataset_name + '/cleaned.csv' -%}
    {% include 'aggregation/' + gene_set + '.snakefile' %}
{% endif -%}
{% endfor -%}
{% endfor -%}

