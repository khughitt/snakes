################################################################################
#                  _             
#  ___ _ __   __ _| | _____  ___ 
# / __| '_ \ / _` | |/ / _ \/ __|
# \__ \ | | | (_| |   <  __/\__ \
# |___/_| |_|\__,_|_|\_\___||___/
#                               
# Data integration and machine learning pipeline built on Snakemake
#
# https://github.com/khughitt/snakes
#
{% set title_underline = '-' * (config['name'] | length + config['version'] | length + 1) -%}
#  {{ config['name'] }} {{ config['version'] }}
#  {{ title_underline }}
#
#  Config : {{ config['config_file'] }}
#  Date   : {{ date_str }}
#
#  Data sources:
{% for dataset_name, dataset_params in datasets.items() -%}
#    - {{ dataset_name }}: {{ dataset_params['path'] }}
{% endfor -%}
#
{% set output_dir = '/'.join([config['output_dir'], config['name'] | replace(' ', '_'), config['version']]) -%}
#  Output dir: {{ output_dir }} 
#    
################################################################################
import glob
import os
import yaml
import numpy as np
import pandas as pd

# load sample and response metadata
sample_metadata   = pd.read_csv('{{ config["metadata"]["samples"] }}', index_col=0)
response_metadata = pd.read_csv('{{ config["metadata"]["response"] }}', index_col=0)

# create output directory, if needed
output_dir = '{{ output_dir }}' 

if not os.path.exists(output_dir):
    os.makedirs(output_dir, mode=0o755)

{############################################################################################-#}
{#                                                                                           -#}
{# Global variables                                                                          -#}
{#                                                                                           -#}
{############################################################################################-#}
{# list used to keep track of different feature sources to use for training set construction -#}
{% set training_set_features = [] -%}

{# list used to keep track of simple rules that should not be run on a cluster               -#}
{% set local_rules = [] -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Load features                                                                             -#}
{#                                                                                           -#}
{############################################################################################-#}
{% for dataset_name, dataset_params in datasets.items() -%}
{% include 'data/' + dataset_params['name'] + '.snakefile' -%}
{% endfor -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Cluster aggregation                                                                       -#}
{#                                                                                           -#}
{############################################################################################-#}
{% for clust_method, clust_params in config['clustering'].items() -%}
{% for dataset_name, dataset_params in datasets.items() -%}
{% if dataset_params['role'] == 'feature' -%}
{% set cur_input = "%s/features/%s.csv" | format(output_dir, dataset_name) -%}
{% include 'aggregation/clustering_' + clust_method + '.snakefile' %}
{% endif -%}
{% endfor %}
{% endfor %}

{############################################################################################-#}
{#                                                                                           -#}
{# Gene set aggregation                                                                      -#}
{#                                                                                           -#}
{############################################################################################-#}
{% for gene_set, gene_set_params in config['gene_sets'].items() -%}
{% for dataset_name, dataset_params in datasets.items() -%}
{% if dataset_params['role'] == 'feature' -%}
{% set cur_input = "%s/features/%s.csv" | format(output_dir, dataset_name) -%}
{% include 'aggregation/gene_set_' + gene_set + '.snakefile' %}
{% endif -%}
{% endfor %}
{% endfor %}

################################################################################
#
# Combine features
#
################################################################################
rule combine_features:
    input: expand("{{ output_dir }}/features/{features}", features={{ training_set_features }})
    output: "{{ output_dir }}/training_set.csv"

################################################################################
#
# Other settings
#
################################################################################
{% set localrules_str = ', '.join(local_rules) -%}
localrules: {{ localrules_str }}


