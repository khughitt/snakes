################################################################################
#                  _             
#  ___ _ __   __ _| | _____  ___ 
# / __| '_ \ / _` | |/ / _ \/ __|
# \__ \ | | | (_| |   <  __/\__ \
# |___/_| |_|\__,_|_|\_\___||___/
#                               
# Data integration and machine learning pipeline built on Snakemake
#
# https://github.com/khughitt/snakes
#
################################################################################
import glob
import os
import yaml
import pandas as pd

#
#  {{ config['name'] }} {{ config['version'] }}
#

# load sample and response metadata
sample_metadata   = yaml.load(open('{{ config['metadata']['samples'] }}'))
response_metadata = yaml.load(open('{{ config['metadata']['response'] }}'))

{# list used to keep track of different feature sources to use for training set construction -#}
{% set training_set_features = [] -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Load features                                                                             -#}
{#                                                                                           -#}
{############################################################################################-#}
{% for key, dataset in datasets.items() -%}
    {% include 'data/' + dataset['name'] + '.snakefile' -%}
{% endfor -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Aggregation                                                                               -#}
{#                                                                                           -#}
{############################################################################################-#}
{% for clust_method, clust_params in config['clustering'].items() -%}
{% for dataset_name, dataset_params in datasets.items() -%}
{% if dataset_params['role'] == 'feature' -%}
    {% set cur_input = "%s/features/%s_cleaned.csv" | format(config['output_dir'], dataset_name) -%}
    {% include 'aggregation/' + clust_method + '.snakefile' %}
{% endif -%}
{% endfor -%}
{% endfor -%}

{% for gene_set, gene_set_params in config['gene_sets'].items() -%}
{% for dataset_name, dataset_params in datasets.items() -%}
{% if dataset_params['role'] == 'feature' -%}
    {% set cur_input = "%s/features/%s_cleaned.csv" | format(config['output_dir'], dataset_name) -%}
    {% include 'aggregation/' + gene_set + '.snakefile' %}
{% endif -%}
{% endfor -%}
{% endfor -%}

{############################################################################################-#}
{#                                                                                           -#}
{# Combine features                                                                          -#}
{#                                                                                           -#}
{############################################################################################-#}
rule combine_features:
    input: "{{ config['output_dir'] }}/features/*.csv" 
    output: "{{ config['output_dir'] }}/training_set.csv"

